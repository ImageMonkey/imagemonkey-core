FROM golang:1.14.4-buster

# when changing the base image, change also the debian version here
ARG DEBIAN_VERSION=buster

RUN mkdir -p /home/go/bin
#ENV GOPATH=/home/go
#ENV GOBIN=/home/go/bin

COPY tests/ /tmp/tests
COPY src/commons /tmp/src/commons
COPY src/clients /tmp/src/clients
COPY src/ioutils /tmp/src/ioutils
COPY src/statworker.go /tmp/src/statworker.go
COPY src/data_processor.go /tmp/src/data_processor.go
COPY src/bot.go /tmp/src/bot.go
COPY src/labels_downloader.go /tmp/src/labels_downloader.go
COPY src/trendinglabelsworker.go /tmp/src/trendinglabelsworker.go
COPY src/make_labels_productive.go /tmp/src/make_labels_productive.go
COPY src/image /tmp/src/image
COPY src/languages /tmp/src/languages
COPY src/datastructures /tmp/src/datastructures
COPY src/go.mod /tmp/src/go.mod
COPY src/go.sum /tmp/src/go.sum
COPY src/datastructures /tmp/src/datastructures

RUN true #docker workaround (https://github.com/moby/moby/issues/37965)

COPY src/populate_labels.go /tmp/src/populate_labels.go
COPY src/database /tmp/src/database
COPY src/image /tmp/src/image
COPY src/parser /tmp/src/parser
COPY env/postgres /tmp/env/postgres

RUN echo "deb http://apt.postgresql.org/pub/repos/apt/ ${DEBIAN_VERSION}-pgdg main" > /etc/apt/sources.list.d/pgdg.list \
    && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - \
	&& apt-get update \
	&& apt-get install -y --no-install-recommends python3 postgresql-client-9.6 python3-pip wget unzip \
	&& pip3 install selenium requests \
	&& wget https://chromedriver.storage.googleapis.com/2.44/chromedriver_linux64.zip --directory-prefix=/tmp/ \
	&& cd /tmp \
	&& unzip /tmp/chromedriver_linux64.zip \ 
	&& cp /tmp/chromedriver /tmp/tests/ui \
	&& rm /tmp/chromedriver_linux64.zip \
	&& wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb --directory-prefix=/tmp/ \
	&& apt install -y --no-install-recommends ./google-chrome-stable_current_amd64.deb \
	&& rm /tmp/google-chrome-stable_current_amd64.deb 

RUN cd /tmp \
	&& wget https://github.com/tsenart/vegeta/releases/download/v12.7.0/vegeta-12.7.0-linux-amd64.tar.gz --directory-prefix=/tmp/ \
	&& tar xvf vegeta-12.7.0-linux-amd64.tar.gz \
	&& cd /tmp/ \
	&& rm -f /tmp/vegeta-12.7.0-linux-amd64.tar.gz \
	&& rm -f /tmp/CHANGELOG \
	&& rm -f /tmp/README.md \
	&& rm -f /tmp/LICENSE \
	&& mv /tmp/vegeta /usr/bin/vegeta

RUN cd /tmp/tests && go get -u gopkg.in/resty.v1
RUN cd /tmp/tests && go test -c -o test	

RUN cd /tmp/src/parser && go test -c -o parser_test && cp parser_test /tmp/tests/parser_test
RUN cd /tmp/src/parser/v2 && go test -c -o parserv2_test && cp parserv2_test /tmp/tests/parserv2_test

WORKDIR /tmp/tests/

RUN wget https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh --directory-prefix=/tmp/ \
	&& chmod u+rx /tmp/wait-for-it.sh

COPY env/docker/run_all_tests.sh /tmp/tests/run_all_tests.sh
COPY env/docker/run_loadtests.sh /tmp/tests/run_loadtests.sh
COPY tests/stresstest/requests.txt /tmp/tests/loadtests.txt

RUN chmod u+rx ./run_all_tests.sh

ENTRYPOINT ["./run_all_tests.sh"]
